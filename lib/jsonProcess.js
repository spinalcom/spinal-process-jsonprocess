"use strict";

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

// Generated by CoffeeScript 2.3.1
(function () {
  // Copyright 2015 SpinalCom - www.spinalcom.com

  // This file is part of SpinalCore.

  // Please read all of the following terms and conditions
  // of the Free Software license Agreement ("Agreement")
  // carefully.

  // This Agreement is a legally binding contract between
  // the Licensee (as defined below) and SpinalCom that
  // sets forth the terms and conditions that govern your
  // use of the Program. By installing and/or using the
  // Program, you agree to abide by all the terms and
  // conditions stated or referenced herein.

  // If you do not agree to abide by these terms and
  // conditions, do not demonstrate your acceptance and do
  // not install or use the Program.

  // You should have received a copy of the license along
  // with this file. If not, see
  // <http://resources.spinalcom.com/licenses.pdf>.
  var G_root;

  G_root = typeof window === "undefined" ? global : window;

  require("spinal-core-connectorjs");

  G_root.JsonProcess = function () {
    var JsonProcess = function (_G_root$Process) {
      _inherits(JsonProcess, _G_root$Process);

      function JsonProcess(model, max_depth, load_ptr, depth) {
        _classCallCheck(this, JsonProcess);

        var handler, i, len, ref;

        var _this = _possibleConstructorReturn(this, (JsonProcess.__proto__ || Object.getPrototypeOf(JsonProcess)).call(this, model, false));

        _this._model = model;
        _this._depth = depth;
        _this._max_depth = max_depth;
        _this._load_ptr = load_ptr;
        _this._json = {
          _server_id: model._server_id,
          _constructor_name: model.constructor.name,
          data: null
        };
        _this.handler = null;
        ref = G_root.JsonProcess._type_handler;
        for (i = 0, len = ref.length; i < len; i++) {
          handler = ref[i];
          if (_this._model instanceof handler.modelType) {
            _this.handler = handler.handler;
            break;
          }
        }
        if (_this.handler === null) {
          // it shouldn't happend
          throw new Error("jsonProcess, imposible to find an handle for " + _this._model.constructor.name);
        }
        _this._onChange = [];
        _this._onLocalChange = [];
        _this._onChildChange = [];
        // wait rdy
        _this._is_rdy = _this.update();
        return _this;
      }

      _createClass(JsonProcess, [{
        key: "setOnChange",
        value: function setOnChange(cb) {
          return G_root.JsonProcess._registerCallback(this._onChange, cb);
        }
      }, {
        key: "setOnLocalChange",
        value: function setOnLocalChange(cb) {
          return G_root.JsonProcess._registerCallback(this._onLocalChange, cb);
        }
      }, {
        key: "setOnChildChange",
        value: function setOnChildChange(cb) {
          return G_root.JsonProcess._registerCallback(this._onChildChange, cb);
        }
      }, {
        key: "update",
        value: function update() {
          if (this._max_depth < this._depth) {
            return Promise.resolve({
              _server_id: this._json._server_id,
              _constructor_name: this._model.constructor.name
            });
          }
          return this.handler.call(this);
        }
      }, {
        key: "onchange",
        value: function onchange() {
          var _this2 = this;

          // update json
          if (this._model.has_been_directly_modified()) {
            return this.update().then(function () {
              G_root.JsonProcess._callbackInArray(_this2._onLocalChange);
              return G_root.JsonProcess._callbackInArray(_this2._onChange);
            });
          } else {
            G_root.JsonProcess._callbackInArray(this._onChildChange);
            return G_root.JsonProcess._callbackInArray(this._onChange);
          }
        }
      }], [{
        key: "create_JsonProcess",
        value: function create_JsonProcess(model) {
          var max_depth = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;
          var load_ptr = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
          var depth = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 0;

          depth += 1;
          if (!max_depth) {
            max_depth = depth + 2;
          }
          // wait model rdy
          return G_root.JsonProcess._wait_model_sync_server(model).then(function () {
            if (typeof G_root.JsonProcess._JsonProcess[model._server_id] === "undefined") {
              G_root.JsonProcess._JsonProcess[model._server_id] = new G_root.JsonProcess(model, max_depth, load_ptr, depth);
            }
            return G_root.JsonProcess._JsonProcess[model._server_id]._is_rdy;
          });
        }
      }, {
        key: "create_JsonProcess_by_server_id",
        value: function create_JsonProcess_by_server_id(server_id, max_depth, load_ptr, depth) {
          return G_root.JsonProcess.create_JsonProcess(FileSystem._objects[server_id], _max_depth, load_ptr, depth);
        }
      }, {
        key: "_register_handler",
        value: function _register_handler(handler) {
          G_root.JsonProcess._type_handler.push(handler);
          return G_root.JsonProcess._type_handler.sort(G_root.JsonProcess._register_sort);
        }
      }, {
        key: "_register_sort",
        value: function _register_sort(a, b) {
          return b.prority - a.prority;
        }
      }, {
        key: "_assignWithKey",
        value: function _assignWithKey(_data, model_key, _model) {
          return G_root.JsonProcess._assignWithModel.call(this, _data, model_key, _model[model_key]);
        }
      }, {
        key: "_assignWithModel",
        value: function _assignWithModel(_data, model_key, _model) {
          return G_root.JsonProcess.create_JsonProcess(_model, this._max_depth, this._load_ptr, this._depth).then(function (child) {
            _data[model_key] = child;
            return _data;
          });
        }
      }, {
        key: "_assignPush",
        value: function _assignPush(_json, _model) {
          return G_root.JsonProcess.create_JsonProcess(_model, this._max_depth, this._load_ptr, this._depth).then(function (child) {
            _json.data.push(child);
            return _json;
          });
        }
      }, {
        key: "_callbackInArray",
        value: function _callbackInArray(arr) {
          var i, len, obj, results;
          results = [];
          for (i = 0, len = arr.length; i < len; i++) {
            obj = arr[i];
            results.push(obj.func());
          }
          return results;
        }
      }, {
        key: "_registerCallback",
        value: function _registerCallback(arr, cb) {
          var obj;
          obj = {
            id: G_root.JsonProcess._registerID++,
            func: cb
          };
          return function () {
            var idx;
            idx = arr.indexOf(obj);
            if (idx !== -1) {
              return arr.splice(idx, 1);
            }
          };
        }
      }, {
        key: "_wait_model_sync_server_loop",
        value: function _wait_model_sync_server_loop(model, resolve) {
          if (typeof model._server_id === 'undefined' || typeof FileSystem._tmp_objects[model._server_id] !== 'undefined' || typeof FileSystem._objects[model._server_id] === 'undefined') {
            return setTimeout(function () {
              return G_root.JsonProcess._wait_model_sync_server_loop(model, resolve);
            }, 200);
          } else {
            return resolve();
          }
        }
      }, {
        key: "_wait_model_sync_server",
        value: function _wait_model_sync_server(model) {
          return new Promise(function (resolve) {
            return G_root.JsonProcess._wait_model_sync_server_loop(model, resolve);
          });
        }
      }]);

      return JsonProcess;
    }(G_root.Process);

    ;

    JsonProcess._type_handler = [];

    JsonProcess._JsonProcess = [];

    JsonProcess._registerID = 0;

    return JsonProcess;
  }.call(this);

  module.exports = {
    JsonProcess: JsonProcess,
    default: JsonProcess.create_JsonProcess
  };
}).call(undefined);
//# sourceMappingURL=data:application/json;base64,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OztBQUNBLGdCQUFBLFdBQUEsR0FBYyxDQUFkOzs7R0FIVyxDLElBQUEsQyxJQUFBLENBQVA7O0FBb0lOLFNBQUEsT0FBQSxHQUFpQjtBQUFBLDRCQUFBO0FBRWYsYUFBUyxZQUFZO0FBRk4sR0FBakI7Q0EvSkEsRSxJQUFBIiwic291cmNlc0NvbnRlbnQiOlsiIyBDb3B5cmlnaHQgMjAxNSBTcGluYWxDb20gLSB3d3cuc3BpbmFsY29tLmNvbVxuI1xuIyBUaGlzIGZpbGUgaXMgcGFydCBvZiBTcGluYWxDb3JlLlxuI1xuIyBQbGVhc2UgcmVhZCBhbGwgb2YgdGhlIGZvbGxvd2luZyB0ZXJtcyBhbmQgY29uZGl0aW9uc1xuIyBvZiB0aGUgRnJlZSBTb2Z0d2FyZSBsaWNlbnNlIEFncmVlbWVudCAoXCJBZ3JlZW1lbnRcIilcbiMgY2FyZWZ1bGx5LlxuI1xuIyBUaGlzIEFncmVlbWVudCBpcyBhIGxlZ2FsbHkgYmluZGluZyBjb250cmFjdCBiZXR3ZWVuXG4jIHRoZSBMaWNlbnNlZSAoYXMgZGVmaW5lZCBiZWxvdykgYW5kIFNwaW5hbENvbSB0aGF0XG4jIHNldHMgZm9ydGggdGhlIHRlcm1zIGFuZCBjb25kaXRpb25zIHRoYXQgZ292ZXJuIHlvdXJcbiMgdXNlIG9mIHRoZSBQcm9ncmFtLiBCeSBpbnN0YWxsaW5nIGFuZC9vciB1c2luZyB0aGVcbiMgUHJvZ3JhbSwgeW91IGFncmVlIHRvIGFiaWRlIGJ5IGFsbCB0aGUgdGVybXMgYW5kXG4jIGNvbmRpdGlvbnMgc3RhdGVkIG9yIHJlZmVyZW5jZWQgaGVyZWluLlxuI1xuIyBJZiB5b3UgZG8gbm90IGFncmVlIHRvIGFiaWRlIGJ5IHRoZXNlIHRlcm1zIGFuZFxuIyBjb25kaXRpb25zLCBkbyBub3QgZGVtb25zdHJhdGUgeW91ciBhY2NlcHRhbmNlIGFuZCBkb1xuIyBub3QgaW5zdGFsbCBvciB1c2UgdGhlIFByb2dyYW0uXG4jXG4jIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIGxpY2Vuc2UgYWxvbmdcbiMgd2l0aCB0aGlzIGZpbGUuIElmIG5vdCwgc2VlXG4jIDxodHRwOi8vcmVzb3VyY2VzLnNwaW5hbGNvbS5jb20vbGljZW5zZXMucGRmPi5cblxuXG5HX3Jvb3QgPSBpZiB0eXBlb2Ygd2luZG93ID09IFwidW5kZWZpbmVkXCIgdGhlbiBnbG9iYWwgZWxzZSB3aW5kb3dcbnJlcXVpcmUoXCJzcGluYWwtY29yZS1jb25uZWN0b3Jqc1wiKVxuXG5jbGFzcyBHX3Jvb3QuSnNvblByb2Nlc3MgZXh0ZW5kcyBHX3Jvb3QuUHJvY2Vzc1xuICBAX3R5cGVfaGFuZGxlcjogW11cbiAgQF9Kc29uUHJvY2VzczogW11cbiAgQF9yZWdpc3RlcklEOiAwXG5cbiAgY29uc3RydWN0b3I6IChtb2RlbCwgbWF4X2RlcHRoLCBsb2FkX3B0ciwgZGVwdGgpIC0+XG4gICAgc3VwZXIgbW9kZWwsIGZhbHNlXG4gICAgQF9tb2RlbCA9IG1vZGVsXG4gICAgQF9kZXB0aCA9IGRlcHRoXG4gICAgQF9tYXhfZGVwdGggPSBtYXhfZGVwdGhcbiAgICBAX2xvYWRfcHRyID0gbG9hZF9wdHJcbiAgICBAX2pzb24gPSB7XG4gICAgICBfc2VydmVyX2lkOiBtb2RlbC5fc2VydmVyX2lkXG4gICAgICBfY29uc3RydWN0b3JfbmFtZTogbW9kZWwuY29uc3RydWN0b3IubmFtZSxcbiAgICAgIGRhdGE6IG51bGxcbiAgICB9XG4gICAgQGhhbmRsZXIgPSBudWxsXG4gICAgZm9yIGhhbmRsZXIgaW4gR19yb290Lkpzb25Qcm9jZXNzLl90eXBlX2hhbmRsZXJcbiAgICAgIGlmIChAX21vZGVsIGluc3RhbmNlb2YgaGFuZGxlci5tb2RlbFR5cGUpXG4gICAgICAgIEBoYW5kbGVyID0gaGFuZGxlci5oYW5kbGVyXG4gICAgICAgIGJyZWFrXG4gICAgaWYgKEBoYW5kbGVyID09IG51bGwpXG4gICAgICAjIGl0IHNob3VsZG4ndCBoYXBwZW5kXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJqc29uUHJvY2VzcywgaW1wb3NpYmxlIHRvIGZpbmQgYW4gaGFuZGxlIGZvciAje0BfbW9kZWwuY29uc3RydWN0b3IubmFtZX1cIilcblxuICAgIEBfb25DaGFuZ2UgPSBbXVxuICAgIEBfb25Mb2NhbENoYW5nZSA9IFtdXG4gICAgQF9vbkNoaWxkQ2hhbmdlID0gW11cblxuICAgICMgd2FpdCByZHlcbiAgICBAX2lzX3JkeSA9IEB1cGRhdGUoKVxuXG5cbiAgQGNyZWF0ZV9Kc29uUHJvY2VzczogKG1vZGVsLCBtYXhfZGVwdGggPSBudWxsLCBsb2FkX3B0ciA9IGZhbHNlLCBkZXB0aCA9IDApIC0+XG4gICAgZGVwdGggKz0gMVxuICAgIGlmIG5vdCBtYXhfZGVwdGhcbiAgICAgIG1heF9kZXB0aCA9IGRlcHRoICsgMlxuICAgICMgd2FpdCBtb2RlbCByZHlcbiAgICByZXR1cm4gR19yb290Lkpzb25Qcm9jZXNzLl93YWl0X21vZGVsX3N5bmNfc2VydmVyKG1vZGVsKS50aGVuKCgpIC0+XG4gICAgICBpZiAodHlwZW9mIEdfcm9vdC5Kc29uUHJvY2Vzcy5fSnNvblByb2Nlc3NbbW9kZWwuX3NlcnZlcl9pZF0gaXMgXCJ1bmRlZmluZWRcIilcbiAgICAgICAgR19yb290Lkpzb25Qcm9jZXNzLl9Kc29uUHJvY2Vzc1ttb2RlbC5fc2VydmVyX2lkXSA9XG4gICAgICAgICAgbmV3IEdfcm9vdC5Kc29uUHJvY2Vzcyhtb2RlbCwgbWF4X2RlcHRoLCBsb2FkX3B0ciwgZGVwdGgpXG4gICAgICByZXR1cm4gR19yb290Lkpzb25Qcm9jZXNzLl9Kc29uUHJvY2Vzc1ttb2RlbC5fc2VydmVyX2lkXS5faXNfcmR5XG4gICAgKVxuXG4gIEBjcmVhdGVfSnNvblByb2Nlc3NfYnlfc2VydmVyX2lkOiAoc2VydmVyX2lkLCBtYXhfZGVwdGgsIGxvYWRfcHRyLCBkZXB0aCkgLT5cbiAgICBHX3Jvb3QuSnNvblByb2Nlc3MuY3JlYXRlX0pzb25Qcm9jZXNzKEZpbGVTeXN0ZW0uX29iamVjdHNbc2VydmVyX2lkXSwgX21heF9kZXB0aCxcbiAgICBsb2FkX3B0ciwgZGVwdGgpXG5cbiAgc2V0T25DaGFuZ2U6IChjYikgLT5cbiAgICBHX3Jvb3QuSnNvblByb2Nlc3MuX3JlZ2lzdGVyQ2FsbGJhY2soQF9vbkNoYW5nZSwgY2IpXG4gIHNldE9uTG9jYWxDaGFuZ2U6IChjYikgLT5cbiAgICBHX3Jvb3QuSnNvblByb2Nlc3MuX3JlZ2lzdGVyQ2FsbGJhY2soQF9vbkxvY2FsQ2hhbmdlLCBjYilcbiAgc2V0T25DaGlsZENoYW5nZTogKGNiKSAtPlxuICAgIEdfcm9vdC5Kc29uUHJvY2Vzcy5fcmVnaXN0ZXJDYWxsYmFjayhAX29uQ2hpbGRDaGFuZ2UsIGNiKVxuXG4gIHVwZGF0ZTogLT5cbiAgICBpZiAoQF9tYXhfZGVwdGggPCBAX2RlcHRoKVxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgIF9zZXJ2ZXJfaWQ6IEBfanNvbi5fc2VydmVyX2lkXG4gICAgICAgIF9jb25zdHJ1Y3Rvcl9uYW1lOiBAX21vZGVsLmNvbnN0cnVjdG9yLm5hbWUsXG4gICAgICB9KVxuICAgIHJldHVybiBAaGFuZGxlci5jYWxsKEApXG4gICAgXG4gIEBfcmVnaXN0ZXJfaGFuZGxlcjogKGhhbmRsZXIpIC0+XG4gICAgR19yb290Lkpzb25Qcm9jZXNzLl90eXBlX2hhbmRsZXIucHVzaChoYW5kbGVyKVxuICAgIEdfcm9vdC5Kc29uUHJvY2Vzcy5fdHlwZV9oYW5kbGVyLnNvcnQoR19yb290Lkpzb25Qcm9jZXNzLl9yZWdpc3Rlcl9zb3J0KVxuICBAX3JlZ2lzdGVyX3NvcnQ6IChhLCBiKSAtPlxuICAgIHJldHVybiBiLnByb3JpdHkgLSBhLnByb3JpdHlcblxuICBAX2Fzc2lnbldpdGhLZXk6IChfZGF0YSwgbW9kZWxfa2V5LCBfbW9kZWwpIC0+XG4gICAgcmV0dXJuIEdfcm9vdC5Kc29uUHJvY2Vzcy5fYXNzaWduV2l0aE1vZGVsLmNhbGwoQCwgX2RhdGEsIG1vZGVsX2tleSwgX21vZGVsW21vZGVsX2tleV0pXG4gIEBfYXNzaWduV2l0aE1vZGVsOiAoX2RhdGEsIG1vZGVsX2tleSwgX21vZGVsKSAtPlxuICAgIHJldHVybiBHX3Jvb3QuSnNvblByb2Nlc3NcbiAgICAgIC5jcmVhdGVfSnNvblByb2Nlc3MoX21vZGVsLCBAX21heF9kZXB0aCxcbiAgICAgIEBfbG9hZF9wdHIsIEBfZGVwdGgpLnRoZW4oXG4gICAgICAgIChjaGlsZCkgLT5cbiAgICAgICAgICBfZGF0YVttb2RlbF9rZXldID0gY2hpbGRcbiAgICAgICAgICByZXR1cm4gX2RhdGFcbiAgICAgIClcblxuICBAX2Fzc2lnblB1c2g6IChfanNvbiwgX21vZGVsKSAtPlxuICAgIHJldHVybiBHX3Jvb3QuSnNvblByb2Nlc3NcbiAgICAgIC5jcmVhdGVfSnNvblByb2Nlc3MoX21vZGVsLCBAX21heF9kZXB0aCxcbiAgICAgIEBfbG9hZF9wdHIsIEBfZGVwdGgpXG4gICAgICAudGhlbihcbiAgICAgICAgKGNoaWxkKSAtPlxuICAgICAgICAgIF9qc29uLmRhdGEucHVzaChjaGlsZClcbiAgICAgICAgICByZXR1cm4gX2pzb25cbiAgICAgIClcblxuICBvbmNoYW5nZTogLT5cbiAgICAjIHVwZGF0ZSBqc29uXG4gICAgaWYgKEBfbW9kZWwuaGFzX2JlZW5fZGlyZWN0bHlfbW9kaWZpZWQoKSlcbiAgICAgICAgQHVwZGF0ZSgpLnRoZW4oKCkgPT5cbiAgICAgICAgICBHX3Jvb3QuSnNvblByb2Nlc3MuX2NhbGxiYWNrSW5BcnJheShAX29uTG9jYWxDaGFuZ2UpXG4gICAgICAgICAgR19yb290Lkpzb25Qcm9jZXNzLl9jYWxsYmFja0luQXJyYXkoQF9vbkNoYW5nZSlcbiAgICAgICAgKVxuICAgIGVsc2VcbiAgICAgIEdfcm9vdC5Kc29uUHJvY2Vzcy5fY2FsbGJhY2tJbkFycmF5KEBfb25DaGlsZENoYW5nZSlcbiAgICAgIEdfcm9vdC5Kc29uUHJvY2Vzcy5fY2FsbGJhY2tJbkFycmF5KEBfb25DaGFuZ2UpXG5cbiAgQF9jYWxsYmFja0luQXJyYXk6IChhcnIpIC0+XG4gICAgZm9yIG9iaiBpbiBhcnJcbiAgICAgIG9iai5mdW5jKClcblxuICBAX3JlZ2lzdGVyQ2FsbGJhY2s6IChhcnIsIGNiKSAtPlxuICAgIG9iaiA9IHtcbiAgICAgIGlkOiBHX3Jvb3QuSnNvblByb2Nlc3MuX3JlZ2lzdGVySUQrK1xuICAgICAgZnVuYzogY2JcbiAgICB9XG4gICAgcmV0dXJuICgoKSAtPlxuICAgICAgaWR4ID0gYXJyLmluZGV4T2Yob2JqKVxuICAgICAgaWYgaWR4ICE9IC0xXG4gICAgICAgIGFyci5zcGxpY2UoaWR4LCAxKVxuICAgIClcbiAgQF93YWl0X21vZGVsX3N5bmNfc2VydmVyX2xvb3A6IChtb2RlbCwgcmVzb2x2ZSkgLT5cbiAgICBpZiAodHlwZW9mIG1vZGVsLl9zZXJ2ZXJfaWQgPT0gJ3VuZGVmaW5lZCcgfHxcbiAgICB0eXBlb2YgRmlsZVN5c3RlbS5fdG1wX29iamVjdHNbbW9kZWwuX3NlcnZlcl9pZF0gIT0gJ3VuZGVmaW5lZCcgfHxcbiAgICB0eXBlb2YgRmlsZVN5c3RlbS5fb2JqZWN0c1ttb2RlbC5fc2VydmVyX2lkXSA9PSAndW5kZWZpbmVkJylcbiAgICAgIHNldFRpbWVvdXQoXG4gICAgICAgICgpIC0+IEdfcm9vdC5Kc29uUHJvY2Vzcy5fd2FpdF9tb2RlbF9zeW5jX3NlcnZlcl9sb29wKG1vZGVsLCByZXNvbHZlKVxuICAgICAgLCAyMDApXG4gICAgZWxzZVxuICAgICAgcmVzb2x2ZSgpXG5cbiAgQF93YWl0X21vZGVsX3N5bmNfc2VydmVyOiAobW9kZWwpIC0+XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSAtPlxuICAgICAgR19yb290Lkpzb25Qcm9jZXNzLl93YWl0X21vZGVsX3N5bmNfc2VydmVyX2xvb3AobW9kZWwsIHJlc29sdmUpXG4gICAgKVxuXG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBKc29uUHJvY2VzcyxcbiAgZGVmYXVsdDogSnNvblByb2Nlc3MuY3JlYXRlX0pzb25Qcm9jZXNzXG59Il0sInNvdXJjZVJvb3QiOiIuLiJ9
//# sourceURL=/home/laurent/share_to_send/modules/spinal-process-jsonprocess/src/jsonProcess.coffee